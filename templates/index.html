<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>å®æ—¶æ¢è„¸ç³»ç»Ÿ</title>
  <script src="https://cdn.socket.io/3.1.3/socket.io.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    #camera-result-wrapper {
      display: flex;
      gap: 40px;
      align-items: center;
    }
    video, img {
      width: 480px;
      height: 360px;
      border: 2px solid #ccc;
      border-radius: 8px;
      object-fit: cover;
    }
    #face-gallery {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 20px 0;
    }
    #face-gallery img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border: 2px solid transparent;
      cursor: pointer;
      border-radius: 8px;
    }
    #face-gallery img.selected {
      border-color: blue;
    }
    #controls {
      margin-top: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-right: 10px;
    }
    #fps {
      font-weight: bold;
      color: green;
    }
    #status {
      font-weight: bold;
      margin-top: 10px;
      color: #007BFF;
    }
  </style>
</head>
<body>
  <h2>ä¸Šä¼ å¤šå¼ äººè„¸å›¾ç‰‡ï¼Œé€‰æ‹©ä¸€å¼ æ¢è„¸</h2>
  <input type="file" id="upload" multiple />
  <div id="face-gallery"></div>

  <div id="camera-result-wrapper">
    <div>
      <h3>ğŸ¥ æ‘„åƒå¤´ç”»é¢</h3>
      <video id="video" autoplay muted></video>
    </div>
    <div>
      <h3>ğŸ­ æ¢è„¸ç»“æœ</h3>
      <img id="result" alt="æ¢è„¸åç»“æœ">
    </div>
  </div>

  <div id="controls">
    <button id="startBtn">â–¶ï¸ å¼€å§‹æ¢è„¸</button>
    <button id="stopBtn">â¹ï¸ åœæ­¢æ¢è„¸</button>
    <button id="saveBtn">ğŸ’¾ ä¿å­˜ç»“æœå›¾</button>
    <span id="fps">FPS: 0ï¼ˆå‘é€: 0, æ¥æ”¶: 0ï¼‰</span>
    <div id="status">çŠ¶æ€ï¼šç­‰å¾…</div>
  </div>

  <canvas id="canvas" hidden></canvas>

  <script>
    const socket = io();
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const result = document.getElementById('result');
    const faceGallery = document.getElementById('face-gallery');
    const fpsText = document.getElementById('fps');
    const status = document.getElementById('status');

    let streaming = false;
    let timer = null;
    let sendCount = 0;
    let receiveCount = 0;
    let faceImages = [];
    let selectedFaceIndex = 0;

    document.getElementById('upload').onchange = function () {
      const files = this.files;

      Array.from(files).forEach((file) => {
        const reader = new FileReader();
        reader.onload = function (e) {
          const img = document.createElement('img');
          img.src = e.target.result;

          const currentIndex = faceImages.length; // å›ºå®šå½“å‰å›¾ç‰‡å¯¹åº”çš„ç´¢å¼•
          img.onclick = () => {
            selectedFaceIndex = currentIndex;
            Array.from(faceGallery.children).forEach(child => child.classList.remove('selected'));
            img.classList.add('selected');
            status.innerText = `âœ… å·²é€‰æ‹©ç¬¬${selectedFaceIndex + 1}å¼ äººè„¸`;
          };

          faceGallery.appendChild(img);
          img.click(); // è‡ªåŠ¨é€‰æ‹©æ–°ä¸Šä¼ çš„äººè„¸
          faceImages.push(e.target.result);
        };
        reader.readAsDataURL(file);
      });

      this.value = ''; // é˜²æ­¢è¿ç»­ä¸Šä¼ åŒä¸€æ–‡ä»¶è§¦å‘ä¸äº†
    };

    navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
      video.srcObject = stream;
    });

    document.getElementById('startBtn').onclick = () => {
      if (streaming || faceImages.length === 0) {
        if (faceImages.length === 0) alert('â—è¯·å…ˆä¸Šä¼ å¹¶é€‰æ‹©äººè„¸ï¼');
        return;
      }
      status.innerText = "ğŸ¬ æ¢è„¸ä¸­...";
      streaming = true;
      timer = setInterval(() => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const image_data = canvas.toDataURL('image/jpeg');
        socket.emit('image', {
          image_data,
          face_image: faceImages[selectedFaceIndex]
        });
        sendCount++;
      }, 400); // 1.5ç§’ä¸€å¸§
    };

    document.getElementById('stopBtn').onclick = () => {
      streaming = false;
      clearInterval(timer);
      status.innerText = "â¹ï¸ å·²åœæ­¢æ¢è„¸";
    };

    document.getElementById('saveBtn').onclick = () => {
      if (!result.src || result.src.startsWith('data:image')) {
        const a = document.createElement('a');
        a.href = result.src;
        a.download = 'swap_result.jpg';
        a.click();
        status.innerText = "âœ… å·²ä¿å­˜ç»“æœå›¾åƒ";
      } else {
        alert("â—å½“å‰æ²¡æœ‰æ¢è„¸ç»“æœå¯ä¿å­˜ï¼");
      }
    };

    socket.on('response_back', function (data) {
      result.src = data.image_data;
      receiveCount++;
    });

    setInterval(() => {
      fpsText.innerText = `FPS: ${receiveCount}ï¼ˆå‘é€: ${sendCount}, æ¥æ”¶: ${receiveCount})`;
      sendCount = 0;
      receiveCount = 0;
    }, 1000);
  </script>
</body>
</html>
